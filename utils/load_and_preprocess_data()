import pandas as pd
import numpy as np
from sklearn.preprocessing import MinMaxScaler

def load_and_preprocess_data(df, seq_len=10):
    date_column = next((col for col in df.columns if 'date' in col.lower()), None)
    if not date_column:
        raise ValueError("No date column found. Include a column like 'Date'.")

    df[date_column] = pd.to_datetime(df[date_column], dayfirst=True)
    df.set_index(date_column, inplace=True)

    features = ['LME_Nickel_Spot', 'USD_Index', 'Oil_Price', 'PMI_Index']
    missing = [f for f in features if f not in df.columns]
    if missing:
        raise ValueError(f"Missing required columns: {', '.join(missing)}")

    df = df[features].dropna()

    if len(df) <= seq_len + 1:
        raise ValueError(f"Not enough rows after cleaning. Got {len(df)} rows, need at least {seq_len + 2}.")

    scaler = MinMaxScaler()
    scaled = scaler.fit_transform(df)

    X, y = [], []
    for i in range(len(scaled) - seq_len):
        X.append(scaled[i:i+seq_len])
        y.append(scaled[i+seq_len][0])

    if len(X) == 0:
        raise ValueError("Failed to generate sequences. Try reducing SEQ_LEN or check data.")

    return np.array(X[-100:]), np.array(y[-100:]), scaler, scaled[-100:]
